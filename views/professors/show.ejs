<% layout('layouts/boilerplate') %>

<div class="container py-5">
  <!-- Profile Card -->
  <div class="card shadow-lg border-0 rounded-4 p-4 mb-5">
    <div class="d-flex flex-wrap align-items-center gap-4">
      <img 
        src="<%= professor.image && professor.image.url ? professor.image.url : '/images/default-professor.jpg' %>"
        alt="<%= professor.name %>"
        class="rounded-circle border border-3 border-light shadow-sm"
        style="width: 130px; height: 130px; object-fit: cover;"
      >

      <div class="flex-grow-1">
        <h2 class="fw-bold mb-1 text-primary"><%= professor.name %></h2>
        <p class="text-muted mb-1"><i class="bi bi-building"></i> <%= professor.department %></p>
        <p class="text-muted mb-2"><i class="bi bi-mortarboard"></i> <%= professor.university %></p>

        <% if (professor.description && professor.description.trim() !== "") { %>
          <p class="text-secondary"><%= professor.description %></p>
        <% } else { %>
          <p class="text-muted fst-italic">No description provided.</p>
        <% } %>
      </div>

      <!-- Overall Rating -->
      <div class="ms-auto text-center">
        <h4 class="fw-bold text-warning mb-1">
          <%= professor.averageRating ? professor.averageRating.toFixed(2) : "N/A" %> ★
        </h4>
        <small class="text-muted">Overall Rating</small>
      </div>
    </div>

    <!-- Admin Controls -->
    <% if (currentUser && currentUser.isAdmin) { %>
      <div class="mt-4 text-end">
        <a href="/professors/<%= professor._id %>/edit" class="btn btn-outline-warning me-2">
          <i class="bi bi-pencil-square"></i> Edit
        </a>
        <form 
          action="/professors/<%= professor._id %>?_method=DELETE"
          method="POST"
          class="d-inline"
          onsubmit="return confirm('Are you sure you want to delete this professor? This action cannot be undone.')">
          <button class="btn btn-outline-danger">
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
      </div>
    <% } %>
  </div>

  <!-- Rating Metrics -->
  <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
    <h4 class="fw-bold mb-4 text-center text-primary">Performance Overview</h4>
    <div class="row text-center g-4">
      <div class="col-md-4">
        <h6 class="fw-semibold text-secondary">Attendance</h6>
        <div class="progress" style="height: 12px;">
          <div class="progress-bar bg-warning" style="width: <%= (attendanceAvg / 5) * 100 %>%"></div>
        </div>
        <p class="fw-semibold mt-2 mb-0"><%= attendanceAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">(<%= professor.reviews.length %> ratings)</small>
      </div>

      <div class="col-md-4">
        <h6 class="fw-semibold text-secondary">Grading Fairness</h6>
        <div class="progress" style="height: 12px;">
          <div class="progress-bar bg-info" style="width: <%= (gradingAvg / 5) * 100 %>%"></div>
        </div>
        <p class="fw-semibold mt-2 mb-0"><%= gradingAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">(<%= professor.reviews.length %> ratings)</small>
      </div>

      <div class="col-md-4">
        <h6 class="fw-semibold text-secondary">Teaching & Study Material</h6>
        <div class="progress" style="height: 12px;">
          <div class="progress-bar bg-success" style="width: <%= (fypAvg / 5) * 100 %>%"></div>
        </div>
        <p class="fw-semibold mt-2 mb-0"><%= fypAvg.toFixed(1) %> / 5</p>
        <small class="text-muted">(<%= professor.reviews.length %> ratings)</small>
      </div>
    </div>
  </div>

  <!-- ===== Student Reviews (updated: auto-enable scroll when >4) ===== -->
<div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0 text-primary">Student Reviews</h4>

    <!-- Sort pill dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-primary rounded-pill dropdown-toggle px-4 py-2 sort-pill"
              id="sortDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" data-current-sort="newest">
        <span id="sortLabel">Sort Reviews</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="sortDropdownBtn">
        <li><a class="dropdown-item sort-option" href="javascript:void(0)" data-sort="newest">Newest</a></li>
        <li><a class="dropdown-item sort-option" href="javascript:void(0)" data-sort="oldest">Oldest</a></li>
        <li><a class="dropdown-item sort-option" href="javascript:void(0)" data-sort="best">Top Rated</a></li>
        <li><a class="dropdown-item sort-option" href="javascript:void(0)" data-sort="worst">Lowest Rated</a></li>
      </ul>
    </div>
  </div>

  <% if (professor.reviews && professor.reviews.length > 0) { %>
    <!-- reviews-list gets .force-scroll via inline server-side when >4 -->
    <div id="reviewsList"
     class="reviews-list <%= (professor.reviews && professor.reviews.length > 4) ? 'force-scroll' : '' %>"
     style="<%= (professor.reviews && professor.reviews.length > 4) ? 'max-height:320px; height:320px; overflow-y:auto;' : '' %>"
     tabindex="0"
     aria-label="Student reviews">

        <% professor.reviews.forEach(review => {
             const individualAvg = ((review.attendance + review.grading + review.fypSupport) / 3);
             const individualAvgFixed = individualAvg.toFixed(1);
             const stars = Math.round(individualAvg);
             const created = review.createdAt ? new Date(review.createdAt).toISOString() : '';
        %>
          <div class="review-item border-start border-3 border-primary bg-light-subtle rounded-3 p-3 mb-3 shadow-sm"
               data-rating="<%= individualAvg %>" data-date="<%= created %>">
            <div class="d-flex justify-content-between align-items-center">
              <strong><%= review.author.username %></strong>
              <span class="text-warning">
                <% for (let i = 0; i < stars; i++) { %>⭐<% } %>
                <small class="text-muted"><%= individualAvgFixed %>/5</small>
              </span>
            </div>
            <p class="mt-2 mb-1"><%= review.body %></p>
            <small class="text-muted"><%= review.createdAt ? review.createdAt.toDateString() : "Date not available" %></small>

            <% if (currentUser && (review.author._id.equals(currentUser._id) || currentUser.isAdmin)) { %>
              <div class="mt-2">
                <a href="/professors/<%= professor._id %>/reviews/<%= review._id %>/edit" class="btn btn-sm btn-outline-primary me-2">Edit</a>
                <form action="/professors/<%= professor._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this review?');">
                  <button class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            <% } %>
          </div>
        <% }) %>
      </div>
    </div> 
  <% } else { %>
    <p class="text-muted text-center">No reviews yet.</p>
  <% } %>
</div>
<!-- ===== end student reviews block ===== -->

<!-- Inline JS: enable scroll after 4 reviews + sorting (fixed) -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const listEl = document.getElementById('reviewsList');
  const sortBtn = document.getElementById('sortDropdownBtn');
  const sortLabelEl = document.getElementById('sortLabel');

  if (!listEl || !sortBtn) {
    console.warn('reviews: required elements missing', { hasList: !!listEl, hasSortBtn: !!sortBtn });
    return;
  }

  // Count review items
  const itemsNodeList = listEl.querySelectorAll('.review-item');
  const count = itemsNodeList.length;

  // Defensive: ensure force-scroll class + inline styles are present when >4
  if (count > 4) {
    listEl.classList.add('force-scroll');
    // only set inline style if not present
    if (!listEl.style.maxHeight) {
      listEl.style.maxHeight = '320px';
      listEl.style.height = '320px';
      listEl.style.overflowY = 'auto';
    }
  } else {
    listEl.classList.remove('force-scroll');
    // optionally clear inline style when <=4
    // listEl.style.maxHeight = '';
    // listEl.style.height = '';
    // listEl.style.overflowY = '';
  }

  // helper to get items as array
  function getItems() {
    return Array.from(listEl.querySelectorAll('.review-item'));
  }

  // comparator functions
  const comparators = {
    newest: (a, b) => (new Date(b.dataset.date || 0)) - (new Date(a.dataset.date || 0)),
    oldest: (a, b) => (new Date(a.dataset.date || 0)) - (new Date(b.dataset.date || 0)),
    best: (a, b) => (parseFloat(b.dataset.rating) || 0) - (parseFloat(a.dataset.rating) || 0),
    worst: (a, b) => (parseFloat(a.dataset.rating) || 0) - (parseFloat(b.dataset.rating) || 0)
  };

  // sort and render while preserving scrollTop
  function sortAndRender(mode = 'newest') {
    // preserve current scroll position (px)
    const prevScroll = listEl.scrollTop;

    const arr = getItems();
    arr.sort(comparators[mode] || comparators.newest);

    // append sorted nodes into fragment then replace
    const frag = document.createDocumentFragment();
    arr.forEach(node => frag.appendChild(node));
    listEl.innerHTML = '';
    listEl.appendChild(frag);

    // restore previous scroll position
    setTimeout(() => { listEl.scrollTop = prevScroll; }, 0);
  }

  // expose for debugging if needed
  window.sortAndRender = sortAndRender;

  // handle clicks on dropdown items (delegation)
  document.addEventListener('click', function (ev) {
    const opt = ev.target.closest('.sort-option');
    if (!opt) return;
    ev.preventDefault(); // prevent anchor navigation
    const mode = opt.dataset.sort || 'newest';
    if (sortLabelEl) sortLabelEl.textContent = opt.textContent.trim();
    sortAndRender(mode);
    try { bootstrap.Dropdown.getOrCreateInstance(sortBtn).hide(); } catch (e) {}
    try { sortBtn.focus(); } catch (e) {}
  });

  // keyboard scrolling when reviewsList is focused
  listEl.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowDown') listEl.scrollBy({ top: 120, behavior: 'smooth' });
    else if (e.key === 'ArrowUp') listEl.scrollBy({ top: -120, behavior: 'smooth' });
  });
});
</script>


  <!-- Review Form -->
  <% if (currentUser) { %>
    <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
      <h5 class="fw-bold mb-3 text-primary">Leave a Review</h5>

      <div class="p-3 bg-light border-start border-4 border-danger rounded-3 mb-4">
        <h6 class="fw-semibold text-danger mb-1">Review Guidelines</h6>
        <p class="small text-muted mb-0">
          Please be respectful and professional. Focus on your learning experience and avoid personal remarks.
        </p>
      </div>

      <form action="/professors/<%= professor._id %>/reviews" method="POST">
        <div class="mb-3">
          <label class="form-label fw-semibold">Your Review</label>
          <textarea name="review[body]" rows="3" class="form-control" placeholder="Share your experience..."></textarea>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Attendance</label>
            <select name="review[attendance]" class="form-select">
              <% for (let i = 5; i >= 1; i--) { %>
                <option value="<%= i %>"><%= "⭐".repeat(i) %></option>
              <% } %>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Grading Fairness</label>
            <select name="review[grading]" class="form-select">
              <% for (let i = 5; i >= 1; i--) { %>
                <option value="<%= i %>"><%= "⭐".repeat(i) %></option>
              <% } %>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Teaching & Study Material</label>
            <select name="review[fypSupport]" class="form-select">
              <% for (let i = 5; i >= 1; i--) { %>
                <option value="<%= i %>"><%= "⭐".repeat(i) %></option>
              <% } %>
            </select>
          </div>
        </div>

        <button class="btn btn-primary px-4">Submit Review</button>
      </form>
    </div>
  <% } else { %>
    <p class="text-center text-muted">
      You must be logged in to leave a review.
      <a href="/login" class="fw-semibold text-decoration-none">Login here</a>.
    </p>
  <% } %>
<div class="alert alert-danger border-danger mt-4 rounded-4 p-4">
  <h5 class="fw-bold text-danger mb-2">
    <i class="bi bi-shield-lock-fill"></i> Disclaimer
  </h5>

  <p class="mb-2 small text-secondary">
    The reviews and comments shown on this platform are posted by individual students and represent their personal opinions only.
  </p>

  <p class="mb-2 small text-dark fw-semibold">
    MentorMeter does <u>not</u> verify, control, or endorse the accuracy of any review.
  </p>

  <p class="mb-2 small text-secondary">
    MentorMeter and its administrators are <span class="fw-bold text-dark">not responsible</span> for any statements, claims, or allegations made by users on this website.
    Any individual who posts defamatory, abusive, misleading, or offensive content is solely accountable for their own statements.
  </p>

  <p class="small text-danger fw-semibold mb-0">
    Posting harmful or false remarks may lead to removal of the review and, if necessary, disciplinary or legal action.
  </p>
</div>

</div>
